add_namespace = GEX
add_namespace = GEXTXS
add_namespace = GEXGEA
add_namespace = GEXAOG
add_namespace = GEXTXS
add_namespace = GEXOTT
add_namespace = GEX_foreign

# Main German capitulation event
country_event = {
	id = GEX.1
	title = GEX.1.t
	desc = GEX.1.d
	picture = GFX_report_event_german_reichstag_bombed

	fire_only_once = yes

	trigger = {
		tag = GER
		is_subject = no
		has_war = yes
		if = {
			limit = { NOT = { controls_state = 64 } } #Brandenburg
			surrender_progress > 0.75
		}
		else = {
			surrender_progress > 0.8
		}
	}

	immediate = {
		log = "[GetDateText]: [Root.GetName]: event GEX.1"
		hidden_effect = {
			add_ideas = GEX_flight_of_the_reich
			if = {
				limit = {
					TXS = {
						is_in_faction_with = GER
					}
				}
				set_global_flag = TEX_GEX_candidate
			}

			if = { #Checking for UoB involvement in the war
				limit = {
					ENG = {
						is_in_faction_with = FRA
						has_war_with = GER
						OR = {
							any_war_score > 10
							controls_state = 56
							controls_state = 58
							controls_state = 59
						}
					}
				}
				set_global_flag = UoB_war_par_1
			}
			if = {
				limit = {
					ENG = {
						is_in_faction_with = FRA
						has_war_with = GER
						OR = {
							any_war_score > 25
							AND = {
								controls_state = 5
								controls_state = 62
								controls_state = 86
							}
							controls_state = 64
						}
					}
				}
				set_global_flag = UoB_war_par_2
			}

			random_other_country = {
				limit = { has_war_with = GER }
				news_event = worldnews.145
				country_event = worldtension.25
			}

			LEC = {
				country_event = {
					id = lec.100
					days = 1
				}
			}
			
			every_country = {
				limit = { is_subject_of = GER }
				overlord = {
					set_autonomy = {
						target = PREV
						autonomy_state = autonomy_free
					}
				}
				
			}
			
			every_other_country = {
				limit = {
					OR = {
						is_in_faction_with = GER
						is_subject_of = GER
					}
				}
				set_country_flag = former_reichspakt_member
				add_timed_idea = {
					idea = GEX_fleeing_exiles
					days = 365
				}
			}
			
			AUS = {
				if = {
					limit = {
						NOT = { has_war_with = GER }
					}
					add_timed_idea = {
						idea = GEX_fleeing_exiles
						days = 365
					}
				}
			}
			
			if = {
				limit = {
					GER = { is_ai = yes }
				}
				german_ai_flees = yes
			}
		}
	}

	option = {
		name = GEX.1.a #Assume control of Mittelafrika. We shall fight on from there
		trigger = {#Does Germany flee to MAF?
			is_ai = no
			GEX_can_flee_MAF = yes
		}
		set_country_flag = GER_capitulated
		set_global_flag = GER_flees_to_africa
		custom_effect_tooltip = MAF_player_becomes_GEX
		hidden_effect = {
			MAF = { country_event = GEX.2 }
		}
	}
	
	option = {
		name = GEX.1.b #Assume control of GEA
		trigger = {
			is_ai = no
			GEX_can_flee_GEA = yes
		}
		set_country_flag = GER_capitulated
		set_global_flag = GER_flees_to_asia
		custom_effect_tooltip = GEA_player_becomes_GEX
		hidden_effect = {
			GEA = { country_event = GEX.2 }
		}
	}
	
	option = {
		name = GEX.1.c #Assume control of AOG
		trigger = {
			is_ai = no
			GEX_can_flee_AOG = yes
		}
		set_country_flag = GER_capitulated
		set_global_flag = GER_flees_to_china
		custom_effect_tooltip = AOG_player_becomes_GEX
		hidden_effect = {
			AOG = { country_event = GEX.2 }
		}
	}
	
	option = {
		name = GEX.1.e #Flee to Texas
		trigger = {
			is_ai = no
			GEX_can_flee_TXS = YES
		}
		set_country_flag = GER_capitulated
		set_global_flag = GER_flees_to_texas
		custom_effect_tooltip = TXS_player_becomes_GEX
		hidden_effect = {
			TXS = { country_event = GEX.2 }
		}
	}
	option = {
		name = GEX.1.f #Flee to Ottomans
		trigger = {
			is_ai = no
			GEX_can_flee_OTT = yes
		}
		set_country_flag = GER_capitulated
		set_global_flag = GER_flees_to_turkey
		custom_effect_tooltip = OTT_player_becomes_GEX
		hidden_effect = {
			OTT = { country_event = GEX.2 }
		}
	}
	option = {
		name = GEX.1.g #There is nowhere to run. Surrender!
		trigger = {
			is_ai = no
			GEX_can_flee_MAF = no
			GEX_can_flee_GEA = no
			GEX_can_flee_AOG = no
			GEX_can_flee_TXS = no
			GEX_can_flee_OTT = no
		}
		log = "		-- Germany is capitulating completely, no exile"
		set_country_flag = GER_capitulated
		custom_effect_tooltip = GER_will_capitulate
		swap_ideas = {
			add_idea = GEX_flight_of_the_reich_2
			remove_idea = GEX_flight_of_the_reich
		}
		germany_capitulates = yes
		set_global_flag = GER_did_not_became_GEX
	}
	option = {
		name = GEX.1.h #Ai script
		trigger = {
			is_ai = yes
		}
		german_ai_flees = yes
	}
}

country_event = {
	id = GEX.2
	immediate = { log = "[GetDateText]: [Root.GetName]: event GEX.2" }
	title = GEX.2.t
	desc = { text = GEX.2.d.MAF trigger = { tag = MAF } }
	desc = { text = GEX.2.d.GEA trigger = { tag = GEA } }
	desc = { text = GEX.2.d.AOG trigger = {	tag = AOG NOT = { has_cosmetic_tag = AOG_CHINA_REICH 	has_country_flag = AOG_krupp_flag } } }
	desc = { text = GEX.2.d.AOG_directors 	trigger = { tag = AOG has_country_flag = AOG_krupp_flag } }
	desc = { text = GEX.2.d.AOG_kaiser trigger = { tag = AOG has_cosmetic_tag = AOG_CHINA_REICH } }
	desc = { text = GEX.2.d.TXS trigger = { tag = TXS } }
	desc = { text = GEX.2.d.OTT trigger = { tag = OTT } }
	picture = GFX_report_event_german_reichstag_bombed

	is_triggered_only = yes
	
	option = {
		name = GEX.2.a #Welcome the exiled government and give in to their demands
		ai_chance = {
			factor = 100
		}
		custom_effect_tooltip = MAF_player_becomes_GEX
		GER = {
			country_event = GEX.4
		}
	}
	
	option = {#no
		name = GEX.2.b
		trigger = { NOT = { tag = MAF } }
		
		ai_chance = {
			factor = 0
		}
		
		set_country_flag = GEX_rejected_exiles
		
		if = {
			limit = {
				has_country_leader = { name = "Jomo Kenyatta" ruling_only = yes }
			}
			add_stability = -0.05
		}
		else = {
			add_stability = -0.3
		}
		if = {
			limit = { is_in_faction = yes }
			leave_faction = yes
		}
		GER = {
			country_event = GEX.3
		}
	}
	
	option = {#Lapdogs no longer! Declare the independence of the Mittelafrikan Empire!
		name = GEX.2.c
		trigger = { tag = MAF NOT = { has_country_leader = { name = "Jomo Kenyatta" ruling_only = yes } } }
		
		ai_chance = {
			factor = 0
		}
		
		set_country_flag = GEX_rejected_exiles
		
		if = {
			limit = {
				has_country_leader = { name = "Jomo Kenyatta" ruling_only = yes }
			}
			add_stability = -0.05
		}
		else = {
			add_stability = -0.3
		}
		if = {
			limit = { is_in_faction = yes }
			leave_faction = yes
		}
		GER = {
			country_event = GEX.3
		}
	}
	
	option = {#Kenyatta says no to Kaiserism
		name = GEX.2.e
		trigger = { has_country_leader = { name = "Jomo Kenyatta" } }
		
		ai_chance = {
			factor = 0
		}
		
		set_country_flag = GEX_rejected_exiles
		
		if = {
			limit = {
				has_country_leader = { name = "Jomo Kenyatta" ruling_only = yes }
			}
			add_stability = -0.05
		}
		else = {
			add_stability = -0.3
		}
		if = {
			limit = { is_in_faction = yes }
			leave_faction = yes
		}
		GER = {
			country_event = GEX.3
		}
	}
}
	
# FROM has refused to surrender to the fleeing Germans
country_event = {
	id = GEX.3
	immediate = { log = "[GetDateText]: [Root.GetName]: event GEX.3" }
	title = { text = GEX.3.t.MAF trigger = { FROM = { tag = MAF } } }
	title = { text = GEX.3.t.GEA trigger = { FROM = { tag = GEA } } }
	title = { text = GEX.3.t.AOG trigger = { FROM = { tag = AOG } } }
	title = { text = GEX.3.t.TEX trigger = { FROM = { tag = TEX } } }
	title = { text = GEX.3.t.OTT trigger = { FROM = { tag = OTT } } }
	desc = { text = GEX.3.t.MAF trigger = { FROM = { tag = MAF } } }
	desc = { text = GEX.3.t.GEA trigger = { FROM = { tag = GEA } } }
	desc = { text = GEX.3.t.AOG trigger = { FROM = { tag = AOG } } }
	desc = { text = GEX.3.t.TEX trigger = { FROM = { tag = TEX } } }
	desc = { text = GEX.3.t.OTT trigger = { FROM = { tag = OTT } } }
	picture = GFX_report_event_MAF_tanganyika

	is_triggered_only = yes

	option = {
		name = GEX.3.a #Assume control of Mittelafrika. We shall fight on from there
		trigger = {#Does Germany flee to MAF?
			is_ai = no
			GEX_can_flee_MAF = yes
		}
		set_country_flag = GER_capitulated
		set_global_flag = GER_flees_to_africa
		custom_effect_tooltip = MAF_player_becomes_GEX
		hidden_effect = {
			MAF = { country_event = GEX.2 }
		}
	}
	
	option = {
		name = GEX.3.b #Assume control of GEA
		trigger = {
			is_ai = no
			GEX_can_flee_GEA = yes
		}
		set_country_flag = GER_capitulated
		set_global_flag = GER_flees_to_asia
		custom_effect_tooltip = GEA_player_becomes_GEX
		hidden_effect = {
			GEA = { country_event = GEX.2 }
		}
	}
	
	option = {
		name = GEX.3.c #Assume control of AOG
		trigger = {
			is_ai = no
			GEX_can_flee_AOG = yes
		}
		set_country_flag = GER_capitulated
		set_global_flag = GER_flees_to_china
		custom_effect_tooltip = AOG_player_becomes_GEX
		hidden_effect = {
			AOG = { country_event = GEX.2 }
		}
	}
	
	option = {
		name = GEX.3.e #Flee to Texas
		trigger = {
			is_ai = no
			GEX_can_flee_TXS = YES
		}
		set_country_flag = GER_capitulated
		set_global_flag = GER_flees_to_texas
		custom_effect_tooltip = TXS_player_becomes_GEX
		hidden_effect = {
			TXS = { country_event = GEX.2 }
		}
	}
	option = {
		name = GEX.3.f #Flee to Ottomans
		trigger = {
			is_ai = no
			GEX_can_flee_OTT = yes
		}
		set_country_flag = GER_capitulated
		set_global_flag = GER_flees_to_turkey
		custom_effect_tooltip = OTT_player_becomes_GEX
		hidden_effect = {
			OTT = { country_event = GEX.2 }
		}
	}
	option = {
		name = GEX.3.g #There is nowhere to run. Surrender!
		trigger = {
			is_ai = no
			GEX_can_flee_MAF = no
			GEX_can_flee_GEA = no
			GEX_can_flee_AOG = no
			GEX_can_flee_TXS = no
			GEX_can_flee_OTT = no
		}
		log = "		-- Germany is capitulating completely, no exile"
		set_country_flag = GER_capitulated
		custom_effect_tooltip = GER_will_capitulate
		swap_ideas = {
			add_idea = GEX_flight_of_the_reich_2
			remove_idea = GEX_flight_of_the_reich
		}
		germany_capitulates = yes
		set_global_flag = GER_did_not_became_GEX
	}
	option = {
		name = GEX.3.h #Ai script
		trigger = {
			is_ai = yes
		}
		german_ai_flees = yes
	}
}

# MAF has agreed to take in the fleeing Germans
country_event = {
	id = GEX.4
	immediate = { log = "[GetDateText]: [Root.GetName]: event GEX.4" }
	title = { text = GEX.4.t.MAF trigger = { FROM = { tag = MAF } } }
	title = { text = GEX.4.t.GEA trigger = { FROM = { tag = GEA } } }
	title = { text = GEX.4.t.AOG trigger = { FROM = { tag = AOG } } }
	title = { text = GEX.4.t.TEX trigger = { FROM = { tag = TEX } } }
	title = { text = GEX.4.t.OTT trigger = { FROM = { tag = OTT } } }
	desc = { text = GEX.4.t.MAF trigger = { FROM = { tag = MAF } } }
	desc = { text = GEX.4.t.GEA trigger = { FROM = { tag = GEA } } }
	desc = { text = GEX.4.t.AOG trigger = { FROM = { tag = AOG } } }
	desc = { text = GEX.4.t.TEX trigger = { FROM = { tag = TEX } } }
	desc = { text = GEX.4.t.OTT trigger = { FROM = { tag = OTT } } }
	picture = GFX_report_event_MAF_tanganyika

	is_triggered_only = yes

	option = {
		name = GEX.4.a
		trigger = {
			FROM = { tag = MAF }
		}
		custom_effect_tooltip = MAF_player_becomes_GEX
		hidden_effect = {
			MAF = {
				transfer_technology = yes
			}
			every_unit_leader = {
				set_unit_leader_flag = GEX_exile_leader
				set_nationality = MAF
			}
			every_navy_leader = {
				set_unit_leader_flag = GEX_exile_leader
				set_nationality = MAF
			}
			swap_ideas = {
				add_idea = GEX_flight_of_the_reich_2
				remove_idea = GEX_flight_of_the_reich
			}
			MAF = {
				germany_flees_to_exile = yes
			}
			germany_capitulates = yes
		}
	}
	
	option = {
		name = GEX.4.b
		trigger = {
			FROM = { tag = GEA }
		}
		custom_effect_tooltip = GEA_player_becomes_GEX
		hidden_effect = {
			GEA = {
				transfer_technology = yes
			}
			every_unit_leader = {
				set_unit_leader_flag = GEX_exile_leader
				set_nationality = GEA
			}
			every_navy_leader = {
				set_unit_leader_flag = GEX_exile_leader
				set_nationality = GEA
			}
			swap_ideas = {
				add_idea = GEX_flight_of_the_reich_2
				remove_idea = GEX_flight_of_the_reich
			}
			GEA = {
				germany_flees_to_exile = yes
			}
			germany_capitulates = yes
		}
	}
	
	option = {
		name = GEX.4.c
		trigger = {
			FROM = { tag = AOG }
		}
		custom_effect_tooltip = AOG_player_becomes_GEX
		hidden_effect = {
			AOG = {
				transfer_technology = yes
			}
			every_unit_leader = {
				set_unit_leader_flag = GEX_exile_leader
				set_nationality = AOG
			}
			every_navy_leader = {
				set_unit_leader_flag = GEX_exile_leader
				set_nationality = AOG
			}
			swap_ideas = {
				add_idea = GEX_flight_of_the_reich_2
				remove_idea = GEX_flight_of_the_reich
			}
			AOG = {
				germany_flees_to_exile = yes
			}
			germany_capitulates = yes
		}
	}
	
	option = {
		name = GEX.4.e
		trigger = {
			FROM = { tag = TXS }
		}
		custom_effect_tooltip = TXS_player_becomes_GEX
		hidden_effect = {
			TXS = {
				transfer_technology = yes
			}
			every_unit_leader = {
				set_unit_leader_flag = GEX_exile_leader
				set_nationality = TXS
			}
			every_navy_leader = {
				set_unit_leader_flag = GEX_exile_leader
				set_nationality = TXS
			}
			swap_ideas = {
				add_idea = GEX_flight_of_the_reich_2
				remove_idea = GEX_flight_of_the_reich
			}
			TXS = {
				germany_flees_to_exile = yes
			}
			germany_capitulates = yes
		}
	}
	
	option = {
		name = GEX.4.f
		trigger = {
			FROM = { tag = OTT }
		}
		custom_effect_tooltip = OTT_player_becomes_GEX
		hidden_effect = {
			OTT = {
				transfer_technology = yes
			}
			every_unit_leader = {
				set_unit_leader_flag = GEX_exile_leader
				set_nationality = OTT
			}
			every_navy_leader = {
				set_unit_leader_flag = GEX_exile_leader
				set_nationality = OTT
			}
			swap_ideas = {
				add_idea = GEX_flight_of_the_reich_2
				remove_idea = GEX_flight_of_the_reich
			}
			OTT = {
				germany_flees_to_exile = yes
			}
			germany_capitulates = yes
		}
	}
}